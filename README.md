# Shaka Player History

This is the source of the Shaka Player History live stream.  It is a
dynamically-generated video stream with a visualization of [Shaka Player][]'s
commit history.  The stream loops forever, and the contents of each iteration
of the loop get longer as more commits are added to Shaka Player.

The video frames are generated by an open-source tool called [Gource][].

The audio of the stream is a loop of 24 solo piano works by J.S. Bach.  See
[sources/bach/#readme](sources/bach/) for details.

The full stream is encoded with [FFmpeg][] and packaged into DASH and HLS by
[Shaka Packager][].  These two tools are orchestrated by [Shaka Streamer][],
which also uploads the output to [Google Cloud Storage][].

The live streams are publicly accessible:
 - DASH: https://storage.googleapis.com/shaka-live-assets/player-source.mpd
 - HLS: https://storage.googleapis.com/shaka-live-assets/player-source.m3u8

[Click here to play instantly in Shaka Player.](https://shaka-player-demo.appspot.com/demo/#assetBase64=eyJuYW1lIjoiU2hha2EgSGlzdG9yeSAoREFTSCkiLCJzaG9ydE5hbWUiOiIiLCJpY29uVXJpIjoiIiwibWFuaWZlc3RVcmkiOiJodHRwczovL3N0b3JhZ2UuZ29vZ2xlYXBpcy5jb20vc2hha2EtbGl2ZS1hc3NldHMvcGxheWVyLXNvdXJjZS5tcGQiLCJzb3VyY2UiOiJDdXN0b20iLCJmb2N1cyI6ZmFsc2UsImRpc2FibGVkIjpmYWxzZSwiZXh0cmFUZXh0IjpbXSwiZXh0cmFUaHVtYm5haWwiOltdLCJleHRyYUNoYXB0ZXIiOltdLCJjZXJ0aWZpY2F0ZVVyaSI6bnVsbCwiZGVzY3JpcHRpb24iOm51bGwsImlzRmVhdHVyZWQiOmZhbHNlLCJkcm0iOlsiTm8gRFJNIHByb3RlY3Rpb24iXSwiZmVhdHVyZXMiOlsiVk9EIl0sImxpY2Vuc2VTZXJ2ZXJzIjp7Il9fdHlwZV9fIjoibWFwIn0sImxpY2Vuc2VSZXF1ZXN0SGVhZGVycyI6eyJfX3R5cGVfXyI6Im1hcCJ9LCJyZXF1ZXN0RmlsdGVyIjpudWxsLCJyZXNwb25zZUZpbHRlciI6bnVsbCwiY2xlYXJLZXlzIjp7Il9fdHlwZV9fIjoibWFwIn0sImV4dHJhQ29uZmlnIjpudWxsLCJleHRyYVVpQ29uZmlnIjpudWxsLCJhZFRhZ1VyaSI6bnVsbCwiaW1hVmlkZW9JZCI6bnVsbCwiaW1hQXNzZXRLZXkiOm51bGwsImltYUNvbnRlbnRTcmNJZCI6bnVsbCwiaW1hTWFuaWZlc3RUeXBlIjpudWxsLCJtZWRpYVRhaWxvclVybCI6bnVsbCwibWVkaWFUYWlsb3JBZHNQYXJhbXMiOm51bGwsInVzZUlNQSI6dHJ1ZSwibWltZVR5cGUiOm51bGx9)

[FFmpeg]: https://www.ffmpeg.org/
[Google Cloud Storage]: https://cloud.google.com/storage/
[Gource]: https://gource.io/
[Shaka Packager]: https://github.com/shaka-project/shaka-packager/
[Shaka Player]: https://github.com/shaka-project/shaka-player/
[Shaka Streamer]: https://github.com/shaka-project/shaka-streamer/


## Nota Bene

This is published in the hopes that it is at least interesting, if not useful
to people outside of the Shaka family.  It's also nice for us to have the
details of this stream formalized and revision-controlled.  That said, if you
want to fork it or run your own instances, please go ahead!

We assume that the latest version of Shaka Streamer is installed.  Please
upgrade Streamer when you update this service.

Note that before you install or run this, we have hard-coded certain details
that you might want to adjust if you fork this to upload to another location or
to visualize another repository:

 - `scripts/update-git.sh` and `sources/pre-release.log` hard-code the repo URL https://github.com/shaka-project/shaka-player and certain pre-historical details about Shaka Player
 - `scripts/rename-aliases.sh` and `sources/user-images` are specific to Shaka Player committers
 - `sources/title.txt` mentions Shaka Player
 - `launch-streamer.sh` and `tools/clear-bucket.sh` hard-code the output bucket gs://shaka-live-assets/


## Service Installation

```sh
# Create an unpriveleged user
sudo adduser \
  --quiet \
  --system \
  shaka-player-history \
  --home /opt/shaka-player-history \
  --no-create-home

# Install this repo to /opt/shaka-player-history
git clone https://github.com/shaka-project/shaka-player-history
sudo mv shaka-player-history /opt/shaka-player-history

# Make this owned by the unpriveleged user
sudo chown -R shaka-player-history /opt/shaka-player-history

# Give the unpriveleged user access to your hardware encoder
# One of these groups might work, depending on your distro
sudo usermod -a -G video shaka-player-history || true
sudo usermod -a -G render shaka-player-history || true

# Install dependencies
sudo apt -y install gource xvfb apt-transport-https ca-certificates gnupg curl
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
sudo apt -y update && sudo apt -y install google-cloud-cli
sudo apt -y install python3-yaml python3-distro
sudo python3 -m pip install --upgrade shaka-streamer shaka-streamer-binaries google-cloud-storage || \
sudo python3 -m pip install --upgrade --break-system-packages shaka-streamer shaka-streamer-binaries google-cloud-storage

# Set up Google Cloud credentials with access to your output bucket
sudo su shaka-player-history -s /bin/bash -c 'gcloud init'
sudo su shaka-player-history -s /bin/bash -c 'gcloud auth application-default login'

# Install the service
sudo install -m 0644 /opt/shaka-player-history/shaka-player-history.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable shaka-player-history
sudo systemctl start shaka-player-history
```

## Checking Service Logs

To simply check the raw service logs, use this script:

```sh
./tools/watch-logs.sh
```

To get an interpreted view of those logs, use this script:

```sh
./tools/monitor-encoder-speed.py
```

If everything is healthy and keeping up with real time, the service should
eventually reach a speed of 1.0x.  Ex:

```json
{'TS': '2025-01-15T17:52:31.344017', 'SPEED': 1.0}
```
